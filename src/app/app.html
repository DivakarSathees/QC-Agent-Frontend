<div class="container">
  <!-- <div>
  <h1 style="justify-content: center; display: flex;">AI QC Agent - Project Questions</h1>

  <form (ngSubmit)="fetchQBs()" [formGroup]="qbForm" class="form">
    <label>
      Token:
      <textarea formControlName="authToken" rows="6" placeholder="Paste token here"></textarea>
    </label>

    <label>
      QB name:
      <textarea formControlName="search" rows="6" placeholder="Type QB Name here"></textarea>
    </label>

    <div class="actions">
      <button type="submit" [disabled]="fetchingQBs">Fetch Question Banks</button>
      <span *ngIf="fetchingQBs" class="status">Fetching...</span>
    </div>
  </form>

  <form (ngSubmit)="start()" [formGroup]="form" class="form">
    <label>
      Description (project description you will send):
      <textarea formControlName="description" rows="6" placeholder="Paste project description here"></textarea>
    </label>

    <label>
      Config JSON:
      <textarea formControlName="config" rows="4" placeholder='{"testcases": [...]}'></textarea>
    </label>

    <label>
      Zip file (project boilerplate):
      <input type="file" (change)="onFileChange($event)" accept=".zip" />
    </label>

    <div class="actions">
      <button type="submit" [disabled]="sending">Start Full Run</button>
      <span *ngIf="sending" class="status">Running...</span>
    </div>
  </form>
  </div> -->

  <div>
  <h1 style="justify-content: center; display: flex;">AI QC Agent - Project Questions</h1>

  <!-- üîò Toggle Buttons -->
  <div class="toggle-container">
    <button 
      [ngClass]="{ active: selectedForm === 'qb' }"
      (click)="selectedForm = 'qb'">
      Fetch QB
    </button>
    <button 
      [ngClass]="{ active: selectedForm === 'qc' }"
      (click)="selectedForm = 'qc'">
      Run QC Manually
    </button>
  </div>

  <!-- üîê Fetch Question Banks Form -->
  <form *ngIf="selectedForm === 'qb'"
        (ngSubmit)="fetchQBs()" 
        [formGroup]="qbForm" 
        class="form fade-in">

    <label>
      Token:
      <textarea formControlName="authToken" rows="4" placeholder="Paste token here"></textarea>
    </label>

    <label>
      QB name:
      <input type="text" formControlName="search" placeholder="Type QB Name here" />
    </label>

    <div class="actions">
      <button type="submit" [disabled]="fetchingQBs">Fetch Question Banks</button>
      <span *ngIf="fetchingQBs" class="status">Fetching...</span>
    </div>
  </form>

  <!-- üß† QC Form -->
  <form *ngIf="selectedForm === 'qc'"
        (ngSubmit)="start()" 
        [formGroup]="form" 
        class="form fade-in">

    <label>
      Description (project description you will send):
      <textarea formControlName="description" rows="6" placeholder="Paste project description here"></textarea>
    </label>

    <label>
      Config JSON:
      <textarea formControlName="config" rows="4" placeholder='{"testcases": [...]}'></textarea>
    </label>

    <label>
      Zip file (project boilerplate):
      <input type="file" (change)="onFileChange($event)" accept=".zip" />
    </label>

    <div class="actions">
      <button type="submit" [disabled]="sending">Start Full Run</button>
      <span *ngIf="sending" class="status">Running...</span>
    </div>
  </form>
</div>


  
  <!-- ‚úÖ Question Bank Listing -->

<h2>Fetched Question Banks</h2>
<div *ngIf="filteredQuestionBanks.length; else noQbs">
  <div style="display: flex;
    justify-content: space-between;
    align-items: center;">
    <div>
  <label>
    Filter by Creator:
    <select [(ngModel)]="selectedCreator" (change)="filterByCreator()">
      <option value="">All</option>
      <option *ngFor="let c of uniqueCreators" [value]="c">{{ c }}</option>
    </select>
  </label>
  </div>
<div>
  <div class="actions">
    <button (click)="fetchQuestionsForQB()" [disabled]="!selectedQbId || fetchingQuestions">
      Fetch Questions
    </button>
    <span *ngIf="fetchingQuestions" class="status">Loading...</span>
  </div>
  </div>
  </div>

  <ul class="qb-list">
    <li *ngFor="let qb of filteredQuestionBanks" 
        [class.selected]="selectedQbId === qb.qb_id"
        (click)="selectQB(qb)">
      <strong>{{ qb.qb_name }}</strong> ‚Äî {{ qb.createdBy }} - Questions: {{ qb.questionCount || 'N/A' }}
    </li>
  </ul>

  <!-- <div class="actions">
    <button (click)="fetchQuestionsForQB()" [disabled]="!selectedQbId || fetchingQuestions">
      Fetch Questions
    </button>
    <span *ngIf="fetchingQuestions" class="status">Loading...</span>
  </div> -->
</div>
<ng-template #noQbs>
  <p class="muted">No Question Banks found yet.</p>
</ng-template>

<!-- ‚úÖ Questions under selected QB -->
<div *ngIf="questions.length">
  <div *ngIf="questions.length">
  <h3>Questions in Selected QB</h3>
  <form (ngSubmit)="start()" 
        [formGroup]="form" 
        class="form fade-in">

    

    <label>
      Zip file (project boilerplate):
      <input type="file" (change)="onFileChange($event)" accept=".zip" />
    </label>

    <div class="actions">
      <button type="submit" [disabled]="sending">Start Full Run</button>
      <span *ngIf="sending" class="status">Running...</span>
    </div>
  </form>
<ul class="question-list">
  <li *ngFor="let q of questions; index as i"
      [class.selected]="selectedQuestionId === q.q_id">

    <div class="question-card">
      <!-- Move click only to header -->
      <div class="question-header" 
           (click)="selectQuestion(q)">
        <strong>Q{{ i + 1 }}. {{ q.question_title || 'Project Question' }}</strong>
        <span class="load-label">Click to load for QC</span>
      </div>

      <div class="question-body">
        <div [innerHTML]="q.question_data | slice:0:100"></div>

        <p><strong>Topic:</strong> {{ q.topic?.name || '‚Äî' }}</p>
        <p><strong>Sub Topic:</strong> {{ q.sub_topic?.name || '‚Äî' }}</p>
        <p><strong>Difficulty:</strong> {{ q.manual_difficulty || 'N/A' }}</p>
        <p><strong>Type:</strong> {{ q.question_type }}</p>

        <div *ngIf="q.project_questions?.boilerPlate?.url">
          <a [href]="q.project_questions.boilerPlate.url" target="_blank">
            üîó Download Boilerplate
          </a>
        </div>

        <details *ngIf="q.project_questions?.config?.length">
          <summary>Show Config JSON</summary>
          <pre>{{ q.project_questions.config | json }}</pre>
        </details>

        <form *ngIf="selectedQuestionId === q.q_id" 
              (ngSubmit)="start()" 
              [formGroup]="form" 
              class="form fade-in">

          <label>
            Zip file (project boilerplate):
            <input type="file" (change)="onFileChange($event)" accept=".zip" />
          </label>

          <div class="actions">
            <button type="submit" [disabled]="sending">Start Full Run</button>
            <span *ngIf="sending" class="status">Running...</span>
          </div>
        </form>
      </div>
    </div>
  </li>
</ul>

</div>
</div>


  <section class="results">
    <div class="parent-container">
    <div class="left-container">
    <h2>Request ‚Äî Description sent</h2>
    <!-- <pre class="box">{{ form.value.description }}</pre> -->
    <div [innerHTML]="form.value.description"></div>
    </div>
<div class="right-container">
    <h2>QC Results</h2>
<div *ngIf="qcResult">

  <div *ngFor="let key of getObjectEntries(qcResult)">
  <div class="qc-header" (click)="toggleSection(key.key)">
    <strong>{{ formatKey(key.key) }}</strong>
    <span class="arrow">{{ isExpanded(key.key) ? '‚ñº' : '‚ñ∂' }}</span>
  </div>

  <div *ngIf="isExpanded(key.key)" class="qc-body">
    <div *ngIf="key.key === 'corrections' && key.value?.corrected_description">
      <div [innerHTML]="key.value.corrected_description"></div>
      <!-- corrections_made - text -->
      <div class="corrections-made">
        <h4>Corrections Made:</h4>
        <ul>
          <li *ngFor="let correction of key.value.corrections_made">{{ correction }}</li>
        </ul>
      </div>  
    </div>

    <!-- <div *ngIf="key.key !== 'corrections'">
      <pre>{{ key.value | json }}</pre>
    </div> -->
    <!-- For all non-corrections keys -->
<div *ngIf="key.key !== 'corrections'">

  <!-- Special layout for test_coverage -->
  <div *ngIf="key.key === 'test_coverage'">
    <h3>Test Coverage Summary</h3>
    <p><strong>Coverage Score:</strong> {{ key.value.coverage_score }}%</p>
    <p><strong>Total Tests:</strong> {{ key.value.total_tests }}</p>
    <p *ngIf="key.value.remarks"><strong>Remarks:</strong> {{ key.value.remarks }}</p>

    <div *ngIf="key.value.missing_details?.length">
      <h4>Missing Details:</h4>
      <ul>
        <li *ngFor="let miss of key.value.missing_details">{{ miss }}</li>
      </ul>
    </div>

    <h4>Per-Test Details</h4>
    <table class="coverage-table">
      <thead>
        <tr>
          <th>Test Name</th>
          <th>Covered?</th>
          <th>Missing Info</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let test of key.value.per_test_details">
          <td>{{ test.test_name }}</td>
          <td>
            <span [ngClass]="test.is_covered ? 'badge-covered' : 'badge-missing'">
              {{ test.is_covered ? '‚úÖ Yes' : '‚ùå No' }}
            </span>
          </td>
          <td>
            <ul>
              <li *ngFor="let info of test.missing_info">{{ info }}</li>
              <li *ngIf="!test.missing_info?.length">‚Äî</li>
            </ul>
          </td>
          <td>{{ test.reason }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ‚úÖ Completeness -->
          <div *ngIf="key.key === 'completeness'">
            <h3>Completeness Report</h3>
            <p><strong>Completeness Score:</strong> {{ key.value.completeness_score }}%</p>
            <p *ngIf="key.value.remarks"><strong>Remarks:</strong> {{ key.value.remarks }}</p>

            <div *ngIf="key.value.missing_components?.length">
              <h4>Missing Components:</h4>
              <ul>
                <li *ngFor="let comp of key.value.missing_components">{{ comp }}</li>
              </ul>
            </div>
          </div>

  <!-- Fallback for all other QC results -->
  <!-- üîπ Default JSON fallback for other QC types -->
          <div *ngIf="key.key !== 'test_coverage' && key.key !== 'completeness'">
            <pre>{{ key.value | json }}</pre>
          </div>
</div>

  </div>
</div>

</div>

<div *ngIf="!qcResult" class="muted">
  No QC results yet.
</div>
</div>
</div>



    <h2>Docker Result (streamed)</h2>
    <div *ngIf="dockerResult; else noDocker">
      <p><strong>Build status:</strong> {{ dockerResult.build_result?.status }}</p>
      <p><strong>Image tag:</strong> {{ dockerResult.build_result?.image_tag }}</p>

      <h4>Build logs (partial)</h4>
      <pre class="box">{{ dockerResult.build_result?.logs }}</pre>

      <h4>Run output</h4>
      <pre class="box">{{ dockerResult.run_result?.output }}</pre>
    </div>
    <ng-template #noDocker>
      <p class="muted">Docker result not arrived yet.</p>
    </ng-template>

    <h2>Raw incoming events</h2>
    <div *ngIf="events.length === 0" class="muted">No events yet.</div>
    <ul class="events">
      <li *ngFor="let e of events; index as i">
        <strong>#{{ i + 1 }}:</strong> <pre>{{ e | json }}</pre>
      </li>
    </ul>

    <div *ngIf="error" class="error">
      <strong>Error:</strong> {{ error }}
    </div>
  </section>
  

</div>

<router-outlet></router-outlet>