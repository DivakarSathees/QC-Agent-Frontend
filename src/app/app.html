<div class="container">
  <h1>AI QC - Full Run (Angular 20)</h1>

  <form (ngSubmit)="start()" [formGroup]="form" class="form">
    <label>
      Description (project description you will send):
      <textarea formControlName="description" rows="6" placeholder="Paste project description here"></textarea>
    </label>

    <label>
      Config JSON:
      <textarea formControlName="config" rows="4" placeholder='{"testcases": [...]}'></textarea>
    </label>

    <label>
      Zip file (project boilerplate):
      <input type="file" (change)="onFileChange($event)" accept=".zip" />
    </label>

    <div class="actions">
      <button type="submit" [disabled]="sending">Start Full Run</button>
      <span *ngIf="sending" class="status">Running...</span>
    </div>
  </form>

  <section class="results">
    <h2>Request — Description sent</h2>
    <!-- <pre class="box">{{ form.value.description }}</pre> -->
    <div [innerHTML]="form.value.description"></div>

    <h2>QC Result (streamed)</h2>
<div *ngIf="qcResult">
  <h2>QC Results</h2>

  <div *ngFor="let key of getObjectEntries(qcResult)">
  <div class="qc-header" (click)="toggleSection(key.key)">
    <strong>{{ formatKey(key.key) }}</strong>
    <span class="arrow">{{ isExpanded(key.key) ? '▼' : '▶' }}</span>
  </div>

  <div *ngIf="isExpanded(key.key)" class="qc-body">
    <div *ngIf="key.key === 'corrections' && key.value?.corrected_description">
      <div [innerHTML]="key.value.corrected_description"></div>
      <!-- corrections_made - text -->
      <div class="corrections-made">
        <h4>Corrections Made:</h4>
        <ul>
          <li *ngFor="let correction of key.value.corrections_made">{{ correction }}</li>
        </ul>
      </div>  
    </div>

    <div *ngIf="key.key !== 'corrections'">
      <pre>{{ key.value | json }}</pre>
    </div>
  </div>
</div>

</div>

<div *ngIf="!qcResult" class="muted">
  No QC results yet.
</div>



    <h2>Docker Result (streamed)</h2>
    <div *ngIf="dockerResult; else noDocker">
      <p><strong>Build status:</strong> {{ dockerResult.build_result?.status }}</p>
      <p><strong>Image tag:</strong> {{ dockerResult.build_result?.image_tag }}</p>

      <h4>Build logs (partial)</h4>
      <pre class="box">{{ dockerResult.build_result?.logs }}</pre>

      <h4>Run output</h4>
      <pre class="box">{{ dockerResult.run_result?.output }}</pre>
    </div>
    <ng-template #noDocker>
      <p class="muted">Docker result not arrived yet.</p>
    </ng-template>

    <h2>Raw incoming events</h2>
    <div *ngIf="events.length === 0" class="muted">No events yet.</div>
    <ul class="events">
      <li *ngFor="let e of events; index as i">
        <strong>#{{ i + 1 }}:</strong> <pre>{{ e | json }}</pre>
      </li>
    </ul>

    <div *ngIf="error" class="error">
      <strong>Error:</strong> {{ error }}
    </div>
  </section>
  
  <!-- <app-qc-results [qcResults]="qcResult"></app-qc-results> -->

</div>

<router-outlet></router-outlet>